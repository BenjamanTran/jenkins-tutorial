---
# Deploy application to remote server
- hosts: remote
  become: no
  gather_facts: no
  vars:
    release_date: "{{ lookup('env','RELEASE_DATE') }}"
    deploy_dir: "/usr/share/nginx/html/jenkins/tantt/deploy"
    keep_releases: "{{ lookup('env','KEEP_RELEASES') | default(5) }}"
  environment:
    PYTHONPATH: ""

  tasks:
    # Create deployment directory structure
    - name: Create deployment directory
      raw: mkdir -p "{{ deploy_dir }}" && chmod 755 "{{ deploy_dir }}"

    - name: Create release directory
      raw: mkdir -p "{{ deploy_dir }}/{{ release_date }}" && chmod 755 "{{ deploy_dir }}/{{ release_date }}"

    # Copy files from local to remote
    - name: Copy index.html from local to remote
      raw: |
        # Copy file from local workspace to remote
        cat > /tmp/index.html << 'EOF'
        {{ lookup('file', 'app/index.html') }}
        EOF
        chmod 644 /tmp/index.html
        echo "âœ… Copied file to /tmp/index.html"
      ignore_errors: yes

    - name: Copy index.html tá»« tmp vÃ o release directory
      raw: |
        if [ -f "/tmp/index.html" ]; then
          cat /tmp/index.html > "{{ deploy_dir }}/{{ release_date }}/index.html"
          chmod 644 "{{ deploy_dir }}/{{ release_date }}/index.html"
          echo "âœ… Copied to release directory"
        else
          echo "âŒ /tmp/index.html not found"
          exit 1
        fi
      register: copy_result
      ignore_errors: yes

    - name: Copy index.html vÃ o thÆ° má»¥c app trÃªn remote
      raw: |
        if [ -f "/tmp/index.html" ]; then
          cat /tmp/index.html > "/usr/share/nginx/html/jenkins/tantt/app/index.html"
          chmod 644 "/usr/share/nginx/html/jenkins/tantt/app/index.html"
          echo "âœ… Copied to app directory"
        else
          echo "âŒ /tmp/index.html not found"
        fi
      ignore_errors: yes

    - name: Copy index.html vÃ o thÆ° má»¥c current trÃªn remote
      raw: |
        if [ -f "/tmp/index.html" ]; then
          cat /tmp/index.html > "/usr/share/nginx/html/jenkins/tantt/deploy/current/index.html"
          chmod 644 "/usr/share/nginx/html/jenkins/tantt/deploy/current/index.html"
          echo "âœ… Copied to current directory"
        else
          echo "âŒ /tmp/index.html not found"
        fi
      ignore_errors: yes

    - name: Fallback náº¿u copy tháº¥t báº¡i
      raw: |
        echo "âŒ Copy failed, using fallback content"
        cat > "{{ deploy_dir }}/{{ release_date }}/index.html" << 'EOF'
        <!DOCTYPE html>
        <html>
          <head>
            <title>Demo Deploy</title>
          </head>
          <body>
            <h1>Hello World!</h1>
          </body>
        </html>
        EOF
        chmod 644 "{{ deploy_dir }}/{{ release_date }}/index.html"
      when: copy_result is failed

    - name: Cáº­p nháº­t symlink current
      raw: |
        cd "{{ deploy_dir }}"
        rm -f current
        ln -sf "{{ release_date }}" current

    - name: XÃ³a release cÅ©, chá»‰ giá»¯ láº¡i {{ keep_releases }}
      raw: |
        cd "{{ deploy_dir }}"
        # Äáº¿m sá»‘ thÆ° má»¥c release (tÃªn báº¯t Ä‘áº§u báº±ng 202*)
        release_count=$(ls -1d 202* 2>/dev/null | wc -l)
        if [ "$release_count" -gt "{{ keep_releases }}" ]; then
          # XÃ³a cÃ¡c release cÅ©, chá»‰ giá»¯ láº¡i {{ keep_releases }} release má»›i nháº¥t
          ls -1td 202* 2>/dev/null | tail -n +$(({{ keep_releases }} + 1)) | xargs rm -rf
          echo "âœ… ÄÃ£ xÃ³a cÃ¡c release cÅ©"
        else
          echo "â„¹ï¸ KhÃ´ng cÃ³ release nÃ o cáº§n xÃ³a (hiá»‡n cÃ³: $release_count)"
        fi
      ignore_errors: yes

    # Display deployment success information
    - name: Display deployment success information
      debug:
        msg:
          - "âœ… Remote deployment successful!"
          - "ğŸ“ Deploy directory: {{ deploy_dir }}"
          - "ğŸ“Š Release: {{ release_date }}"
          - "ğŸ”— Current symlink: /usr/share/nginx/html/jenkins/tantt/current"
          - "ğŸŒ Web URL: http://10.1.1.195/jenkins/tantt/deploy/current/"